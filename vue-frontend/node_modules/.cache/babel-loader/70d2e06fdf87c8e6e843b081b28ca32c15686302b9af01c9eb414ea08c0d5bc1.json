{"ast":null,"code":"import { ref, nextTick, computed, onMounted } from 'vue';\nimport { ElMessage } from 'element-plus';\nimport api from '../utils/api';\nexport default {\n  name: 'AIChat',\n  setup() {\n    const sessions = ref({});\n    const currentSessionId = ref(null);\n    const tempSession = ref(false);\n    const currentMessages = ref([]);\n    const inputMessage = ref('');\n    const loading = ref(false);\n    const messagesRef = ref(null);\n    const messageInput = ref(null);\n    const selectedModel = ref('1');\n    const isStreaming = ref(false);\n    const uploading = ref(false);\n    const fileInput = ref(null);\n    const renderMarkdown = text => {\n      if (!text && text !== '') return '';\n      return String(text).replace(/\\*\\*(.*?)\\*\\*/g, '<strong>$1</strong>').replace(/\\*(.*?)\\*/g, '<em>$1</em>').replace(/`(.*?)`/g, '<code>$1</code>').replace(/\\n/g, '<br>');\n    };\n    const playTTS = async text => {\n      try {\n        // åˆ›å»ºTTSä»»åŠ¡\n        const createResponse = await api.post('/AI/chat/tts', {\n          text\n        });\n        if (createResponse.data && createResponse.data.status_code === 1000 && createResponse.data.task_id) {\n          const taskId = createResponse.data.task_id;\n\n          // å…ˆç­‰å¾…5ç§’é’Ÿå†å¼€å§‹è½®è¯¢\n          await new Promise(resolve => setTimeout(resolve, 5000));\n\n          // è½®è¯¢æŸ¥è¯¢ä»»åŠ¡ç»“æœ\n          const maxAttempts = 30;\n          const pollInterval = 2000;\n          let attempts = 0;\n          const pollResult = async () => {\n            const queryResponse = await api.get('/AI/chat/tts/query', {\n              params: {\n                task_id: taskId\n              }\n            });\n            if (queryResponse.data && queryResponse.data.status_code === 1000) {\n              const taskStatus = queryResponse.data.task_status;\n              if (taskStatus === 'Success' && queryResponse.data.task_result) {\n                // ä»»åŠ¡å®Œæˆï¼Œæ’­æ”¾éŸ³é¢‘\n                // åç«¯è¿”å›çš„ task_result æ˜¯ç›´æ¥çš„ URL å­—ç¬¦ä¸²\n                const audio = new Audio(queryResponse.data.task_result);\n                audio.play();\n                return true;\n              } else if (taskStatus === 'Running' || taskStatus === 'Created') {\n                // ä»»åŠ¡è¿›è¡Œä¸­ï¼Œç»§ç»­è½®è¯¢\n                attempts++;\n                if (attempts < maxAttempts) {\n                  await new Promise(resolve => setTimeout(resolve, pollInterval));\n                  return await pollResult();\n                } else {\n                  ElMessage.error('è¯­éŸ³åˆæˆè¶…æ—¶');\n                  return true;\n                }\n              } else {\n                // å…¶ä»–çŠ¶æ€ï¼ˆå¦‚å¤±è´¥ï¼‰\n                ElMessage.error('è¯­éŸ³åˆæˆå¤±è´¥');\n                return true;\n              }\n            }\n            attempts++;\n            if (attempts < maxAttempts) {\n              await new Promise(resolve => setTimeout(resolve, pollInterval));\n              return await pollResult();\n            } else {\n              ElMessage.error('è¯­éŸ³åˆæˆè¶…æ—¶');\n              return true;\n            }\n          };\n          await pollResult();\n        } else {\n          ElMessage.error('æ— æ³•åˆ›å»ºè¯­éŸ³åˆæˆä»»åŠ¡');\n        }\n      } catch (error) {\n        console.error('TTS error:', error);\n        ElMessage.error('è¯·æ±‚è¯­éŸ³æ¥å£å¤±è´¥');\n      }\n    };\n    const loadSessions = async () => {\n      try {\n        const response = await api.get('/AI/chat/sessions');\n        if (response.data && response.data.status_code === 1000 && Array.isArray(response.data.sessions)) {\n          const sessionMap = {};\n          response.data.sessions.forEach(s => {\n            const sid = String(s.sessionId);\n            sessionMap[sid] = {\n              id: sid,\n              name: s.name || `ä¼šè¯ ${sid}`,\n              messages: [] // lazy load\n            };\n          });\n          sessions.value = sessionMap;\n        }\n      } catch (error) {\n        console.error('Load sessions error:', error);\n      }\n    };\n    const createNewSession = () => {\n      currentSessionId.value = 'temp';\n      tempSession.value = true;\n      currentMessages.value = [];\n      // focus input\n      nextTick(() => {\n        if (messageInput.value) messageInput.value.focus();\n      });\n    };\n    const switchSession = async sessionId => {\n      if (!sessionId) return;\n      currentSessionId.value = String(sessionId);\n      tempSession.value = false;\n\n      // lazy load history if not present\n      if (!sessions.value[sessionId].messages || sessions.value[sessionId].messages.length === 0) {\n        try {\n          const response = await api.post('/AI/chat/history', {\n            sessionId: currentSessionId.value\n          });\n          if (response.data && response.data.status_code === 1000 && Array.isArray(response.data.history)) {\n            const messages = response.data.history.map(item => ({\n              role: item.is_user ? 'user' : 'assistant',\n              content: item.content\n            }));\n            sessions.value[sessionId].messages = messages;\n          }\n        } catch (err) {\n          console.error('Load history error:', err);\n        }\n      }\n      currentMessages.value = [...(sessions.value[sessionId].messages || [])];\n      await nextTick();\n      scrollToBottom();\n    };\n    const syncHistory = async () => {\n      if (!currentSessionId.value || tempSession.value) {\n        ElMessage.warning('è¯·é€‰æ‹©å·²æœ‰ä¼šè¯è¿›è¡ŒåŒæ­¥');\n        return;\n      }\n      try {\n        const response = await api.post('/AI/chat/history', {\n          sessionId: currentSessionId.value\n        });\n        if (response.data && response.data.status_code === 1000 && Array.isArray(response.data.history)) {\n          const messages = response.data.history.map(item => ({\n            role: item.is_user ? 'user' : 'assistant',\n            content: item.content\n          }));\n          sessions.value[currentSessionId.value].messages = messages;\n          currentMessages.value = [...messages];\n          await nextTick();\n          scrollToBottom();\n        } else {\n          ElMessage.error('æ— æ³•è·å–å†å²æ•°æ®');\n        }\n      } catch (err) {\n        console.error('Sync history error:', err);\n        ElMessage.error('è¯·æ±‚å†å²æ•°æ®å¤±è´¥');\n      }\n    };\n    const sendMessage = async () => {\n      if (!inputMessage.value || !inputMessage.value.trim()) {\n        ElMessage.warning('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹');\n        return;\n      }\n      const userMessage = {\n        role: 'user',\n        content: inputMessage.value\n      };\n      const currentInput = inputMessage.value;\n      inputMessage.value = '';\n      currentMessages.value.push(userMessage);\n      await nextTick();\n      scrollToBottom();\n      try {\n        loading.value = true;\n        if (isStreaming.value) {\n          await handleStreaming(currentInput);\n        } else {\n          await handleNormal(currentInput);\n        }\n      } catch (err) {\n        console.error('Send message error:', err);\n        ElMessage.error('å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');\n        if (!tempSession.value && currentSessionId.value && sessions.value[currentSessionId.value] && sessions.value[currentSessionId.value].messages) {\n          const sessionArr = sessions.value[currentSessionId.value].messages;\n          if (sessionArr && sessionArr.length) sessionArr.pop();\n        }\n        currentMessages.value.pop();\n      } finally {\n        if (!isStreaming.value) {\n          loading.value = false;\n        }\n        await nextTick();\n        scrollToBottom();\n      }\n    };\n    async function handleStreaming(question) {\n      const aiMessage = {\n        role: 'assistant',\n        content: '',\n        meta: {\n          status: 'streaming'\n        } // mark streaming\n      };\n      const aiMessageIndex = currentMessages.value.length;\n      currentMessages.value.push(aiMessage);\n      if (!tempSession.value && currentSessionId.value && sessions.value[currentSessionId.value]) {\n        if (!sessions.value[currentSessionId.value].messages) sessions.value[currentSessionId.value].messages = [];\n        sessions.value[currentSessionId.value].messages.push({\n          role: 'assistant',\n          content: ''\n        });\n      }\n      const url = tempSession.value ? '/api/AI/chat/send-stream-new-session' : '/api/AI/chat/send-stream';\n      const headers = {\n        'Content-Type': 'application/json',\n        'Authorization': `Bearer ${localStorage.getItem('token') || ''}`\n      };\n      const body = tempSession.value ? {\n        question: question,\n        modelType: selectedModel.value\n      } : {\n        question: question,\n        modelType: selectedModel.value,\n        sessionId: currentSessionId.value\n      };\n      try {\n        // åˆ›å»º fetch è¿æ¥è¯»å– SSE æµ\n        const response = await fetch(url, {\n          method: 'POST',\n          headers,\n          body: JSON.stringify(body)\n        });\n        if (!response.ok) {\n          loading.value = false;\n          throw new Error('Network response was not ok');\n        }\n        const reader = response.body.getReader();\n        const decoder = new TextDecoder();\n        let buffer = '';\n\n        // è¯»å–æµæ•°æ®\n        // eslint-disable-next-line no-constant-condition\n        while (true) {\n          const {\n            done,\n            value\n          } = await reader.read();\n          if (done) break;\n          const chunk = decoder.decode(value, {\n            stream: true\n          });\n          buffer += chunk;\n\n          // æŒ‰è¡Œåˆ†å‰²\n          const lines = buffer.split('\\n');\n          buffer = lines.pop() || ''; // ä¿ç•™æœªå®Œæˆçš„è¡Œ\n\n          for (const line of lines) {\n            const trimmedLine = line.trim();\n            if (!trimmedLine) continue;\n\n            // å¤„ç† SSE æ ¼å¼ï¼šdata: <content>\n            if (trimmedLine.startsWith('data:')) {\n              const data = trimmedLine.slice(5).trim();\n              console.log('[SSE] Received:', data); // è°ƒè¯•æ—¥å¿—\n\n              if (data === '[DONE]') {\n                // æµç»“æŸ\n                console.log('[SSE] Stream done');\n                loading.value = false;\n                currentMessages.value[aiMessageIndex].meta = {\n                  status: 'done'\n                };\n                currentMessages.value = [...currentMessages.value];\n              } else if (data.startsWith('{')) {\n                // å°è¯•è§£æ JSONï¼ˆå¦‚ sessionIdï¼‰\n                try {\n                  const parsed = JSON.parse(data);\n                  if (parsed.sessionId) {\n                    const newSid = String(parsed.sessionId);\n                    console.log('[SSE] Session ID:', newSid);\n                    if (tempSession.value) {\n                      sessions.value[newSid] = {\n                        id: newSid,\n                        name: 'æ–°ä¼šè¯',\n                        messages: [...currentMessages.value]\n                      };\n                      currentSessionId.value = newSid;\n                      tempSession.value = false;\n                    }\n                  }\n                } catch (e) {\n                  // ä¸æ˜¯ JSONï¼Œå½“ä½œæ™®é€šæ–‡æœ¬å¤„ç†\n                  currentMessages.value[aiMessageIndex].content += data;\n                  console.log('[SSE] Content updated:', currentMessages.value[aiMessageIndex].content.length);\n                }\n              } else {\n                // æ™®é€šæ–‡æœ¬æ•°æ®ï¼Œç›´æ¥è¿½åŠ \n                // ä½¿ç”¨æ•°ç»„ç´¢å¼•ç›´æ¥æ›´æ–°ï¼Œå¼ºåˆ¶ Vue å“åº”å¼ç³»ç»Ÿæ£€æµ‹å˜åŒ–\n                currentMessages.value[aiMessageIndex].content += data;\n                console.log('[SSE] Content updated:', currentMessages.value[aiMessageIndex].content.length);\n              }\n\n              // æ¯æ”¶åˆ°ä¸€æ¡æ•°æ®å°±ç«‹å³æ›´æ–° DOM\n              // å¼ºåˆ¶æ›´æ–°æ•´ä¸ªæ•°ç»„ä»¥è§¦å‘å“åº”å¼\n              currentMessages.value = [...currentMessages.value];\n\n              // ä½¿ç”¨ requestAnimationFrame å¼ºåˆ¶æµè§ˆå™¨é‡æ’\n              await new Promise(resolve => {\n                requestAnimationFrame(() => {\n                  scrollToBottom();\n                  resolve();\n                });\n              });\n            }\n          }\n        }\n\n        // æµè¯»å–å®Œæˆåçš„å¤„ç†\n        loading.value = false;\n        currentMessages.value[aiMessageIndex].meta = {\n          status: 'done'\n        };\n        currentMessages.value = [...currentMessages.value];\n\n        // åŒæ­¥åˆ° sessions å­˜å‚¨\n        if (!tempSession.value && currentSessionId.value && sessions.value[currentSessionId.value]) {\n          const sessMsgs = sessions.value[currentSessionId.value].messages;\n          if (Array.isArray(sessMsgs) && sessMsgs.length) {\n            const lastIndex = sessMsgs.length - 1;\n            if (sessMsgs[lastIndex] && sessMsgs[lastIndex].role === 'assistant') {\n              sessMsgs[lastIndex].content = currentMessages.value[aiMessageIndex].content;\n            }\n          }\n        }\n      } catch (err) {\n        console.error('Stream error:', err);\n        loading.value = false;\n        currentMessages.value[aiMessageIndex].meta = {\n          status: 'error'\n        };\n        currentMessages.value = [...currentMessages.value];\n        ElMessage.error('æµå¼ä¼ è¾“å‡ºé”™');\n      }\n    }\n    async function handleNormal(question) {\n      if (tempSession.value) {\n        const response = await api.post('/AI/chat/send-new-session', {\n          question: question,\n          modelType: selectedModel.value\n        });\n        if (response.data && response.data.status_code === 1000) {\n          const sessionId = String(response.data.sessionId);\n          const aiMessage = {\n            role: 'assistant',\n            content: response.data.Information || ''\n          };\n          sessions.value[sessionId] = {\n            id: sessionId,\n            name: 'æ–°ä¼šè¯',\n            messages: [{\n              role: 'user',\n              content: question\n            }, aiMessage]\n          };\n          currentSessionId.value = sessionId;\n          tempSession.value = false;\n          currentMessages.value = [...sessions.value[sessionId].messages];\n        } else {\n          ElMessage.error(response.data?.status_msg || 'å‘é€å¤±è´¥');\n          currentMessages.value.pop();\n        }\n      } else {\n        const sessionMsgs = sessions.value[currentSessionId.value].messages;\n        sessionMsgs.push({\n          role: 'user',\n          content: question\n        });\n        const response = await api.post('/AI/chat/send', {\n          question: question,\n          modelType: selectedModel.value,\n          sessionId: currentSessionId.value\n        });\n        if (response.data && response.data.status_code === 1000) {\n          const aiMessage = {\n            role: 'assistant',\n            content: response.data.Information || ''\n          };\n          sessionMsgs.push(aiMessage);\n          currentMessages.value = [...sessionMsgs];\n        } else {\n          ElMessage.error(response.data?.status_msg || 'å‘é€å¤±è´¥');\n          sessionMsgs.pop(); // rollback\n          currentMessages.value.pop();\n        }\n      }\n    }\n    const scrollToBottom = () => {\n      if (messagesRef.value) {\n        try {\n          messagesRef.value.scrollTop = messagesRef.value.scrollHeight;\n        } catch (e) {\n          // ignore\n        }\n      }\n    };\n    const triggerFileUpload = () => {\n      if (fileInput.value) {\n        fileInput.value.click();\n      }\n    };\n    const handleFileUpload = async event => {\n      const file = event.target.files[0];\n      if (!file) return;\n\n      // å‰ç«¯æ ¡éªŒï¼šåªå…è®¸.mdæˆ–.txtæ–‡ä»¶\n      const fileName = file.name.toLowerCase();\n      if (!fileName.endsWith('.md') && !fileName.endsWith('.txt')) {\n        ElMessage.error('åªå…è®¸ä¸Šä¼  .md æˆ– .txt æ–‡ä»¶');\n        // æ¸…ç©ºæ–‡ä»¶è¾“å…¥\n        if (fileInput.value) {\n          fileInput.value.value = '';\n        }\n        return;\n      }\n      try {\n        uploading.value = true;\n        const formData = new FormData();\n        formData.append('file', file);\n        const response = await api.post('/file/upload', formData, {\n          headers: {\n            'Content-Type': 'multipart/form-data'\n          }\n        });\n        if (response.data && response.data.status_code === 1000) {\n          ElMessage.success(`æ–‡ä»¶ä¸Šä¼ æˆåŠŸ`);\n        } else {\n          ElMessage.error(response.data?.status_msg || 'ä¸Šä¼ å¤±è´¥');\n        }\n      } catch (error) {\n        console.error('File upload error:', error);\n        ElMessage.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥');\n      } finally {\n        uploading.value = false;\n        // æ¸…ç©ºæ–‡ä»¶è¾“å…¥\n        if (fileInput.value) {\n          fileInput.value.value = '';\n        }\n      }\n    };\n    onMounted(() => {\n      loadSessions();\n    });\n\n    // expose to template\n    return {\n      sessions: computed(() => Object.values(sessions.value)),\n      currentSessionId,\n      tempSession,\n      currentMessages,\n      inputMessage,\n      loading,\n      messagesRef,\n      messageInput,\n      selectedModel,\n      isStreaming,\n      uploading,\n      fileInput,\n      renderMarkdown,\n      playTTS,\n      createNewSession,\n      switchSession,\n      syncHistory,\n      sendMessage,\n      triggerFileUpload,\n      handleFileUpload\n    };\n  }\n};","map":{"version":3,"names":["ref","nextTick","computed","onMounted","ElMessage","api","name","setup","sessions","currentSessionId","tempSession","currentMessages","inputMessage","loading","messagesRef","messageInput","selectedModel","isStreaming","uploading","fileInput","renderMarkdown","text","String","replace","playTTS","createResponse","post","data","status_code","task_id","taskId","Promise","resolve","setTimeout","maxAttempts","pollInterval","attempts","pollResult","queryResponse","get","params","taskStatus","task_status","task_result","audio","Audio","play","error","console","loadSessions","response","Array","isArray","sessionMap","forEach","s","sid","sessionId","id","messages","value","createNewSession","focus","switchSession","length","history","map","item","role","is_user","content","err","scrollToBottom","syncHistory","warning","sendMessage","trim","userMessage","currentInput","push","handleStreaming","handleNormal","sessionArr","pop","question","aiMessage","meta","status","aiMessageIndex","url","headers","localStorage","getItem","body","modelType","fetch","method","JSON","stringify","ok","Error","reader","getReader","decoder","TextDecoder","buffer","done","read","chunk","decode","stream","lines","split","line","trimmedLine","startsWith","slice","log","parsed","parse","newSid","e","requestAnimationFrame","sessMsgs","lastIndex","Information","status_msg","sessionMsgs","scrollTop","scrollHeight","triggerFileUpload","click","handleFileUpload","event","file","target","files","fileName","toLowerCase","endsWith","formData","FormData","append","success","Object","values"],"sources":["/Users/james/Desktop/1.2-CS/00-projects/GopherAI/GopherAI-v2/vue-frontend/src/views/AIChat.vue"],"sourcesContent":["<template>\n  <div class=\"ai-chat-container\">\n    <!-- å·¦ä¾§ä¼šè¯åˆ—è¡¨ -->\n    <div class=\"session-list\">\n      <div class=\"session-list-header\">\n        <span>ä¼šè¯åˆ—è¡¨</span>\n        <button class=\"new-chat-btn\" @click=\"createNewSession\">ï¼‹ æ–°èŠå¤©</button>\n      </div>\n      <ul class=\"session-list-ul\">\n        <li\n          v-for=\"session in sessions\"\n          :key=\"session.id\"\n          :class=\"['session-item', { active: currentSessionId === session.id }]\"\n          @click=\"switchSession(session.id)\"\n        >\n          {{ session.name || `ä¼šè¯ ${session.id}` }}\n        </li>\n      </ul>\n    </div>\n\n    <!-- å³ä¾§èŠå¤©åŒºåŸŸ -->\n    <div class=\"chat-section\">\n      <div class=\"top-bar\">\n        <button class=\"back-btn\" @click=\"$router.push('/menu')\">â† è¿”å›</button>\n        <button class=\"sync-btn\" @click=\"syncHistory\" :disabled=\"!currentSessionId || tempSession\">åŒæ­¥å†å²æ•°æ®</button>\n        <label for=\"modelType\">é€‰æ‹©æ¨¡å‹ï¼š</label>\n        <select id=\"modelType\" v-model=\"selectedModel\" class=\"model-select\">\n          <option value=\"1\">é˜¿é‡Œç™¾ç‚¼</option>\n          <option value=\"2\">é˜¿é‡Œç™¾ç‚¼ RAG</option>\n          <option value=\"3\">é˜¿é‡Œç™¾ç‚¼ MCP</option>\n        </select>\n        <label for=\"streamingMode\" style=\"margin-left: 20px;\">\n          <input type=\"checkbox\" id=\"streamingMode\" v-model=\"isStreaming\" />\n          æµå¼å“åº”\n        </label>\n        <button class=\"upload-btn\" @click=\"triggerFileUpload\" :disabled=\"uploading\">ğŸ“ ä¸Šä¼ æ–‡æ¡£(.md/.txt)</button>\n        <input\n          ref=\"fileInput\"\n          type=\"file\"\n          accept=\".md,.txt,text/markdown,text/plain\"\n          style=\"display: none\"\n          @change=\"handleFileUpload\"\n        />\n      </div>\n\n      <div class=\"chat-messages\" ref=\"messagesRef\">\n        <div\n          v-for=\"(message, index) in currentMessages\"\n          :key=\"index\"\n          :class=\"['message', message.role === 'user' ? 'user-message' : 'ai-message']\"\n        >\n          <div class=\"message-header\">\n            <b>{{ message.role === 'user' ? 'ä½ ' : 'AI' }}:</b>\n            <button v-if=\"message.role === 'assistant'\" class=\"tts-btn\" @click=\"playTTS(message.content)\">ğŸ”Š</button>\n            <span v-if=\"message.meta && message.meta.status === 'streaming'\" class=\"streaming-indicator\"> Â·Â·</span>\n          </div>\n          <div class=\"message-content\" v-html=\"renderMarkdown(message.content)\"></div>\n        </div>\n      </div>\n\n      <div class=\"chat-input\">\n        <textarea\n          v-model=\"inputMessage\"\n          placeholder=\"è¯·è¾“å…¥ä½ çš„é—®é¢˜...\"\n          @keydown.enter.exact.prevent=\"sendMessage\"\n          :disabled=\"loading\"\n          ref=\"messageInput\"\n          rows=\"1\"\n        ></textarea>\n        <button\n          type=\"button\"\n          :disabled=\"!inputMessage.trim() || loading\"\n          @click=\"sendMessage\"\n          class=\"send-btn\"\n        >\n          {{ loading ? 'å‘é€ä¸­...' : 'å‘é€' }}\n        </button>\n      </div>\n    </div>\n  </div>\n</template>\n\n<script>\n\n\nimport { ref, nextTick, computed, onMounted } from 'vue'\nimport { ElMessage } from 'element-plus'\nimport api from '../utils/api'\n\nexport default {\n  name: 'AIChat',\n  setup() {\n\n    const sessions = ref({})\n    const currentSessionId = ref(null)\n    const tempSession = ref(false)\n    const currentMessages = ref([])\n    const inputMessage = ref('')\n    const loading = ref(false)\n    const messagesRef = ref(null)\n    const messageInput = ref(null)\n    const selectedModel = ref('1')\n    const isStreaming = ref(false)\n    const uploading = ref(false)\n    const fileInput = ref(null)\n\n\n    const renderMarkdown = (text) => {\n      if (!text && text !== '') return ''\n      return String(text)\n        .replace(/\\*\\*(.*?)\\*\\*/g, '<strong>$1</strong>')\n        .replace(/\\*(.*?)\\*/g, '<em>$1</em>')\n        .replace(/`(.*?)`/g, '<code>$1</code>')\n        .replace(/\\n/g, '<br>')\n    }\n\n    const playTTS = async (text) => {\n      try {\n        // åˆ›å»ºTTSä»»åŠ¡\n        const createResponse = await api.post('/AI/chat/tts', { text })\n        if (createResponse.data && createResponse.data.status_code === 1000 && createResponse.data.task_id) {\n          const taskId = createResponse.data.task_id\n          \n          // å…ˆç­‰å¾…5ç§’é’Ÿå†å¼€å§‹è½®è¯¢\n          await new Promise(resolve => setTimeout(resolve, 5000))\n          \n          // è½®è¯¢æŸ¥è¯¢ä»»åŠ¡ç»“æœ\n          const maxAttempts = 30\n          const pollInterval = 2000\n          let attempts = 0\n          \n          const pollResult = async () => {\n            const queryResponse = await api.get('/AI/chat/tts/query', { params: { task_id: taskId } })\n            \n            if (queryResponse.data && queryResponse.data.status_code === 1000) {\n              const taskStatus = queryResponse.data.task_status\n                \n              if (taskStatus === 'Success' && queryResponse.data.task_result) {\n                // ä»»åŠ¡å®Œæˆï¼Œæ’­æ”¾éŸ³é¢‘\n                // åç«¯è¿”å›çš„ task_result æ˜¯ç›´æ¥çš„ URL å­—ç¬¦ä¸²\n                const audio = new Audio(queryResponse.data.task_result)\n                audio.play()\n                return true\n              } else if (taskStatus === 'Running' ||taskStatus === 'Created' ) {\n                // ä»»åŠ¡è¿›è¡Œä¸­ï¼Œç»§ç»­è½®è¯¢\n                attempts++\n                if (attempts < maxAttempts) {\n                  await new Promise(resolve => setTimeout(resolve, pollInterval))\n                  return await pollResult()\n                } else {\n                  ElMessage.error('è¯­éŸ³åˆæˆè¶…æ—¶')\n                  return true\n                }\n              } else {\n                // å…¶ä»–çŠ¶æ€ï¼ˆå¦‚å¤±è´¥ï¼‰\n                ElMessage.error('è¯­éŸ³åˆæˆå¤±è´¥')\n                return true\n              }\n            }\n            \n            attempts++\n            if (attempts < maxAttempts) {\n              await new Promise(resolve => setTimeout(resolve, pollInterval))\n              return await pollResult()\n            } else {\n              ElMessage.error('è¯­éŸ³åˆæˆè¶…æ—¶')\n              return true\n            }\n          }\n          \n          await pollResult()\n        } else {\n          ElMessage.error('æ— æ³•åˆ›å»ºè¯­éŸ³åˆæˆä»»åŠ¡')\n        }\n      } catch (error) {\n        console.error('TTS error:', error)\n        ElMessage.error('è¯·æ±‚è¯­éŸ³æ¥å£å¤±è´¥')\n      }\n    }\n\n    const loadSessions = async () => {\n      try {\n        const response = await api.get('/AI/chat/sessions')\n        if (response.data && response.data.status_code === 1000 && Array.isArray(response.data.sessions)) {\n          const sessionMap = {}\n          response.data.sessions.forEach(s => {\n            const sid = String(s.sessionId)\n            sessionMap[sid] = {\n              id: sid,\n              name: s.name || `ä¼šè¯ ${sid}`,\n              messages: [] // lazy load\n            }\n          })\n          sessions.value = sessionMap\n        }\n      } catch (error) {\n        console.error('Load sessions error:', error)\n      }\n    }\n\n    const createNewSession = () => {\n      currentSessionId.value = 'temp'\n      tempSession.value = true\n      currentMessages.value = []\n      // focus input\n      nextTick(() => {\n        if (messageInput.value) messageInput.value.focus()\n      })\n    }\n\n    const switchSession = async (sessionId) => {\n      if (!sessionId) return\n      currentSessionId.value = String(sessionId)\n      tempSession.value = false\n\n      // lazy load history if not present\n      if (!sessions.value[sessionId].messages || sessions.value[sessionId].messages.length === 0) {\n        try {\n          const response = await api.post('/AI/chat/history', { sessionId: currentSessionId.value })\n          if (response.data && response.data.status_code === 1000 && Array.isArray(response.data.history)) {\n            const messages = response.data.history.map(item => ({\n              role: item.is_user ? 'user' : 'assistant',\n              content: item.content\n            }))\n            sessions.value[sessionId].messages = messages\n          }\n        } catch (err) {\n          console.error('Load history error:', err)\n        }\n      }\n\n\n      currentMessages.value = [...(sessions.value[sessionId].messages || [])]\n      await nextTick()\n      scrollToBottom()\n    }\n\n    const syncHistory = async () => {\n      if (!currentSessionId.value || tempSession.value) {\n        ElMessage.warning('è¯·é€‰æ‹©å·²æœ‰ä¼šè¯è¿›è¡ŒåŒæ­¥')\n        return\n      }\n      try {\n        const response = await api.post('/AI/chat/history', { sessionId: currentSessionId.value })\n        if (response.data && response.data.status_code === 1000 && Array.isArray(response.data.history)) {\n          const messages = response.data.history.map(item => ({\n            role: item.is_user ? 'user' : 'assistant',\n            content: item.content\n          }))\n          sessions.value[currentSessionId.value].messages = messages\n          currentMessages.value = [...messages]\n          await nextTick()\n          scrollToBottom()\n        } else {\n          ElMessage.error('æ— æ³•è·å–å†å²æ•°æ®')\n        }\n      } catch (err) {\n        console.error('Sync history error:', err)\n        ElMessage.error('è¯·æ±‚å†å²æ•°æ®å¤±è´¥')\n      }\n    }\n\n\n    const sendMessage = async () => {\n      if (!inputMessage.value || !inputMessage.value.trim()) {\n        ElMessage.warning('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹')\n        return\n      }\n\n      const userMessage = {\n        role: 'user',\n        content: inputMessage.value\n      }\n      const currentInput = inputMessage.value\n      inputMessage.value = ''\n\n\n      currentMessages.value.push(userMessage)\n      await nextTick()\n      scrollToBottom()\n\n      try {\n        loading.value = true\n        if (isStreaming.value) {\n\n          await handleStreaming(currentInput)\n        } else {\n\n          await handleNormal(currentInput)\n        }\n      } catch (err) {\n        console.error('Send message error:', err)\n        ElMessage.error('å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•')\n\n        if (!tempSession.value && currentSessionId.value && sessions.value[currentSessionId.value] && sessions.value[currentSessionId.value].messages) {\n\n          const sessionArr = sessions.value[currentSessionId.value].messages\n          if (sessionArr && sessionArr.length) sessionArr.pop()\n        }\n        currentMessages.value.pop()\n      } finally {\n        if (!isStreaming.value) {\n          loading.value = false\n        }\n        await nextTick()\n        scrollToBottom()\n      }\n    }\n\n\n    async function handleStreaming(question) {\n\n      const aiMessage = {\n        role: 'assistant',\n        content: '',\n        meta: { status: 'streaming' } // mark streaming\n      }\n\n\n      const aiMessageIndex = currentMessages.value.length\n      currentMessages.value.push(aiMessage)\n\n      if (!tempSession.value && currentSessionId.value && sessions.value[currentSessionId.value]) {\n        if (!sessions.value[currentSessionId.value].messages) sessions.value[currentSessionId.value].messages = []\n        sessions.value[currentSessionId.value].messages.push({ role: 'assistant', content: '' })\n      }\n\n\n      const url = tempSession.value\n        ? '/api/AI/chat/send-stream-new-session'  \n        : '/api/AI/chat/send-stream'           \n\n      const headers = {\n        'Content-Type': 'application/json',\n        'Authorization': `Bearer ${localStorage.getItem('token') || ''}`\n      }\n\n      const body = tempSession.value\n        ? { question: question, modelType: selectedModel.value }\n        : { question: question, modelType: selectedModel.value, sessionId: currentSessionId.value }\n\n      try {\n        // åˆ›å»º fetch è¿æ¥è¯»å– SSE æµ\n        const response = await fetch(url, {\n          method: 'POST',\n          headers,\n          body: JSON.stringify(body)\n        })\n\n        if (!response.ok) {\n          loading.value = false\n          throw new Error('Network response was not ok')\n        }\n\n        const reader = response.body.getReader()\n        const decoder = new TextDecoder()\n        let buffer = ''\n\n        // è¯»å–æµæ•°æ®\n        // eslint-disable-next-line no-constant-condition\n        while (true) {\n          const { done, value } = await reader.read()\n          if (done) break\n\n          const chunk = decoder.decode(value, { stream: true })\n          buffer += chunk\n\n          // æŒ‰è¡Œåˆ†å‰²\n          const lines = buffer.split('\\n')\n          buffer = lines.pop() || '' // ä¿ç•™æœªå®Œæˆçš„è¡Œ\n\n          for (const line of lines) {\n            const trimmedLine = line.trim()\n            if (!trimmedLine) continue\n\n            // å¤„ç† SSE æ ¼å¼ï¼šdata: <content>\n            if (trimmedLine.startsWith('data:')) {\n              const data = trimmedLine.slice(5).trim()\n              console.log('[SSE] Received:', data) // è°ƒè¯•æ—¥å¿—\n\n              if (data === '[DONE]') {\n                // æµç»“æŸ\n                console.log('[SSE] Stream done')\n                loading.value = false\n                currentMessages.value[aiMessageIndex].meta = { status: 'done' }\n                currentMessages.value = [...currentMessages.value]\n              } else if (data.startsWith('{')) {\n                // å°è¯•è§£æ JSONï¼ˆå¦‚ sessionIdï¼‰\n                try {\n                  const parsed = JSON.parse(data)\n                  if (parsed.sessionId) {\n                    const newSid = String(parsed.sessionId)\n                    console.log('[SSE] Session ID:', newSid)\n                    if (tempSession.value) {\n                      sessions.value[newSid] = {\n                        id: newSid,\n                        name: 'æ–°ä¼šè¯',\n                        messages: [...currentMessages.value]\n                      }\n                      currentSessionId.value = newSid\n                      tempSession.value = false\n                    }\n                  }\n                } catch (e) {\n                  // ä¸æ˜¯ JSONï¼Œå½“ä½œæ™®é€šæ–‡æœ¬å¤„ç†\n                  currentMessages.value[aiMessageIndex].content += data\n                  console.log('[SSE] Content updated:', currentMessages.value[aiMessageIndex].content.length)\n                }\n              } else {\n                // æ™®é€šæ–‡æœ¬æ•°æ®ï¼Œç›´æ¥è¿½åŠ \n                // ä½¿ç”¨æ•°ç»„ç´¢å¼•ç›´æ¥æ›´æ–°ï¼Œå¼ºåˆ¶ Vue å“åº”å¼ç³»ç»Ÿæ£€æµ‹å˜åŒ–\n                currentMessages.value[aiMessageIndex].content += data\n                console.log('[SSE] Content updated:', currentMessages.value[aiMessageIndex].content.length)\n              }\n\n              // æ¯æ”¶åˆ°ä¸€æ¡æ•°æ®å°±ç«‹å³æ›´æ–° DOM\n              // å¼ºåˆ¶æ›´æ–°æ•´ä¸ªæ•°ç»„ä»¥è§¦å‘å“åº”å¼\n              currentMessages.value = [...currentMessages.value]\n              \n              // ä½¿ç”¨ requestAnimationFrame å¼ºåˆ¶æµè§ˆå™¨é‡æ’\n              await new Promise(resolve => {\n                requestAnimationFrame(() => {\n                  scrollToBottom()\n                  resolve()\n                })\n              })\n            }\n          }\n        }\n\n        // æµè¯»å–å®Œæˆåçš„å¤„ç†\n        loading.value = false\n        currentMessages.value[aiMessageIndex].meta = { status: 'done' }\n        currentMessages.value = [...currentMessages.value]\n\n        // åŒæ­¥åˆ° sessions å­˜å‚¨\n        if (!tempSession.value && currentSessionId.value && sessions.value[currentSessionId.value]) {\n          const sessMsgs = sessions.value[currentSessionId.value].messages\n          if (Array.isArray(sessMsgs) && sessMsgs.length) {\n            const lastIndex = sessMsgs.length - 1\n            if (sessMsgs[lastIndex] && sessMsgs[lastIndex].role === 'assistant') {\n              sessMsgs[lastIndex].content = currentMessages.value[aiMessageIndex].content\n            }\n          }\n        }\n      } catch (err) {\n        console.error('Stream error:', err)\n        loading.value = false\n        currentMessages.value[aiMessageIndex].meta = { status: 'error' }\n        currentMessages.value = [...currentMessages.value]\n        ElMessage.error('æµå¼ä¼ è¾“å‡ºé”™')\n      }\n    }\n\n\n    async function handleNormal(question) {\n      if (tempSession.value) {\n\n        const response = await api.post('/AI/chat/send-new-session', {\n          question: question,\n          modelType: selectedModel.value\n        })\n        if (response.data && response.data.status_code === 1000) {\n          const sessionId = String(response.data.sessionId)\n          const aiMessage = {\n            role: 'assistant',\n            content: response.data.Information || ''\n          }\n\n          sessions.value[sessionId] = {\n            id: sessionId,\n            name: 'æ–°ä¼šè¯',\n            messages: [ { role: 'user', content: question }, aiMessage ]\n          }\n          currentSessionId.value = sessionId\n          tempSession.value = false\n          currentMessages.value = [...sessions.value[sessionId].messages]\n        } else {\n          ElMessage.error(response.data?.status_msg || 'å‘é€å¤±è´¥')\n\n          currentMessages.value.pop()\n        }\n      } else {\n\n        const sessionMsgs = sessions.value[currentSessionId.value].messages\n\n        sessionMsgs.push({ role: 'user', content: question })\n\n        const response = await api.post('/AI/chat/send', {\n          question: question,\n          modelType: selectedModel.value,\n          sessionId: currentSessionId.value\n        })\n        if (response.data && response.data.status_code === 1000) {\n          const aiMessage = { role: 'assistant', content: response.data.Information || '' }\n          sessionMsgs.push(aiMessage)\n          currentMessages.value = [...sessionMsgs]\n        } else {\n          ElMessage.error(response.data?.status_msg || 'å‘é€å¤±è´¥')\n          sessionMsgs.pop() // rollback\n          currentMessages.value.pop()\n        }\n      }\n    }\n\n\n    const scrollToBottom = () => {\n      if (messagesRef.value) {\n        try {\n          messagesRef.value.scrollTop = messagesRef.value.scrollHeight\n        } catch (e) {\n          // ignore\n        }\n      }\n    }\n\n    const triggerFileUpload = () => {\n      if (fileInput.value) {\n        fileInput.value.click()\n      }\n    }\n\n    const handleFileUpload = async (event) => {\n      const file = event.target.files[0]\n      if (!file) return\n\n      // å‰ç«¯æ ¡éªŒï¼šåªå…è®¸.mdæˆ–.txtæ–‡ä»¶\n      const fileName = file.name.toLowerCase()\n      if (!fileName.endsWith('.md') && !fileName.endsWith('.txt')) {\n        ElMessage.error('åªå…è®¸ä¸Šä¼  .md æˆ– .txt æ–‡ä»¶')\n        // æ¸…ç©ºæ–‡ä»¶è¾“å…¥\n        if (fileInput.value) {\n          fileInput.value.value = ''\n        }\n        return\n      }\n\n      try {\n        uploading.value = true\n        const formData = new FormData()\n        formData.append('file', file)\n\n        const response = await api.post('/file/upload', formData, {\n          headers: {\n            'Content-Type': 'multipart/form-data'\n          }\n        })\n\n        if (response.data && response.data.status_code === 1000) {\n          ElMessage.success(`æ–‡ä»¶ä¸Šä¼ æˆåŠŸ`)\n        } else {\n          ElMessage.error(response.data?.status_msg || 'ä¸Šä¼ å¤±è´¥')\n        }\n      } catch (error) {\n        console.error('File upload error:', error)\n        ElMessage.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥')\n      } finally {\n        uploading.value = false\n        // æ¸…ç©ºæ–‡ä»¶è¾“å…¥\n        if (fileInput.value) {\n          fileInput.value.value = ''\n        }\n      }\n    }\n\n    onMounted(() => {\n      loadSessions()\n    })\n\n    // expose to template\n    return {\n      sessions: computed(() => Object.values(sessions.value)),\n      currentSessionId,\n      tempSession,\n      currentMessages,\n      inputMessage,\n      loading,\n      messagesRef,\n      messageInput,\n      selectedModel,\n      isStreaming,\n      uploading,\n      fileInput,\n      renderMarkdown,\n      playTTS,\n      createNewSession,\n      switchSession,\n      syncHistory,\n      sendMessage,\n      triggerFileUpload,\n      handleFileUpload\n    }\n  }\n}\n</script>\n\n<style scoped>\n.ai-chat-container {\n  height: 100vh;\n  display: flex;\n  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n  position: relative;\n  overflow: hidden;\n  font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, \"Helvetica Neue\", Arial;\n  color: #222;\n}\n\n.ai-chat-container::before {\n  content: '';\n  position: absolute;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  background: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\"><circle cx=\"20\" cy=\"20\" r=\"2\" fill=\"rgba(255,255,255,0.08)\"/><circle cx=\"80\" cy=\"80\" r=\"2\" fill=\"rgba(255,255,255,0.08)\"/><circle cx=\"40\" cy=\"60\" r=\"1\" fill=\"rgba(255,255,255,0.06)\"/><circle cx=\"60\" cy=\"30\" r=\"1.5\" fill=\"rgba(255,255,255,0.06)\"/></svg>');\n  animation: float 20s ease-in-out infinite;\n  opacity: 0.25;\n}\n\n@keyframes float {\n  0%, 100% { transform: translateY(0px) rotate(0deg); }\n  50% { transform: translateY(-20px) rotate(180deg); }\n}\n\n.session-list {\n  width: 280px;\n  height: 100vh;\n  overflow: hidden;\n  display: flex;\n  flex-direction: column;\n  background: rgba(255, 255, 255, 0.95);\n  backdrop-filter: blur(15px);\n  border-right: 1px solid rgba(0, 0, 0, 0.08);\n  box-shadow: 2px 0 20px rgba(0, 0, 0, 0.08);\n  position: relative;\n  z-index: 2;\n}\n\n.session-list-header {\n  padding: 20px;\n  text-align: center;\n  font-weight: 600;\n  background: linear-gradient(135deg, rgba(102, 126, 234, 0.06) 0%, rgba(103, 194, 58, 0.06) 100%);\n  border-bottom: 1px solid rgba(0, 0, 0, 0.06);\n  display: flex;\n  flex-direction: column;\n  gap: 12px;\n  align-items: center;\n}\n\n.new-chat-btn {\n  width: 100%;\n  padding: 12px 0;\n  cursor: pointer;\n  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n  color: white;\n  border: none;\n  border-radius: 12px;\n  font-size: 14px;\n  font-weight: 600;\n  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.28);\n  transition: all 0.25s ease;\n  position: relative;\n  overflow: hidden;\n}\n\n.new-chat-btn::before {\n  content: '';\n  position: absolute;\n  top: 0;\n  left: -100%;\n  width: 100%;\n  height: 100%;\n  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.12), transparent);\n  transition: left 0.5s;\n}\n\n.new-chat-btn:hover::before {\n  left: 100%;\n}\n\n.new-chat-btn:hover {\n  transform: translateY(-2px);\n  box-shadow: 0 8px 25px rgba(102, 126, 234, 0.36);\n}\n\n.session-list-ul {\n  list-style: none;\n  padding: 0;\n  margin: 0;\n  flex: 1;\n  overflow-y: auto;\n}\n\n.session-item {\n  padding: 15px 20px;\n  cursor: pointer;\n  border-bottom: 1px solid rgba(0, 0, 0, 0.03);\n  transition: all 0.2s ease;\n  position: relative;\n  color: #2c3e50;\n}\n\n.session-item.active {\n  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n  color: white;\n  font-weight: 600;\n  box-shadow: inset 0 0 20px rgba(102, 126, 234, 0.2);\n}\n\n.session-item:hover {\n  background: rgba(102, 126, 234, 0.06);\n  transform: translateX(4px);\n}\n\n/* chat section */\n.chat-section {\n  flex: 1;\n  display: flex;\n  flex-direction: column;\n  position: relative;\n  z-index: 1;\n  min-width: 0;\n  min-height: 0;\n  overflow: hidden;\n}\n\n.top-bar {\n  background: rgba(255, 255, 255, 0.95);\n  backdrop-filter: blur(10px);\n  color: #2c3e50;\n  display: flex;\n  align-items: center;\n  padding: 12px 24px;\n  box-shadow: 0 2px 14px rgba(0, 0, 0, 0.06);\n  border-bottom: 1px solid rgba(0, 0, 0, 0.06);\n  gap: 12px;\n}\n\n.back-btn {\n  background: rgba(255, 255, 255, 0.22);\n  border: 1px solid rgba(0, 0, 0, 0.06);\n  color: #2c3e50;\n  padding: 8px 14px;\n  border-radius: 10px;\n  cursor: pointer;\n  font-weight: 600;\n  transition: all 0.2s ease;\n  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);\n}\n\n.back-btn:hover {\n  background: rgba(255, 255, 255, 0.32);\n  transform: translateY(-2px);\n  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);\n}\n\n.sync-btn {\n  background: linear-gradient(135deg, #67c23a 0%, #409eff 100%);\n  color: white;\n  padding: 8px 14px;\n  border: none;\n  border-radius: 10px;\n  cursor: pointer;\n  font-size: 13px;\n  font-weight: 600;\n  box-shadow: 0 4px 12px rgba(103, 194, 58, 0.2);\n  transition: all 0.2s ease;\n}\n\n.sync-btn:disabled {\n  background: #ccc;\n  box-shadow: none;\n  cursor: not-allowed;\n}\n\n.model-select {\n  margin-left: 6px;\n  padding: 6px 10px;\n  border: 1px solid rgba(0, 0, 0, 0.06);\n  border-radius: 8px;\n  background: white;\n  color: #2c3e50;\n  font-weight: 600;\n  cursor: pointer;\n  transition: all 0.2s ease;\n}\n\n.upload-btn {\n  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);\n  color: white;\n  padding: 8px 14px;\n  border: none;\n  border-radius: 10px;\n  cursor: pointer;\n  font-size: 13px;\n  font-weight: 600;\n  box-shadow: 0 4px 12px rgba(245, 87, 108, 0.2);\n  transition: all 0.2s ease;\n}\n\n.upload-btn:hover:not(:disabled) {\n  transform: translateY(-2px);\n  box-shadow: 0 6px 16px rgba(245, 87, 108, 0.3);\n}\n\n.upload-btn:disabled {\n  background: #ccc;\n  box-shadow: none;\n  cursor: not-allowed;\n}\n\n.chat-messages {\n  flex: 1;\n  min-height: 0;\n  overflow-y: auto;\n  padding: 30px;\n  display: flex;\n  flex-direction: column;\n  gap: 18px;\n  position: relative;\n  z-index: 1;\n}\n\n/* scrollbar */\n.chat-messages::-webkit-scrollbar {\n  width: 8px;\n}\n.chat-messages::-webkit-scrollbar-thumb {\n  background: rgba(0,0,0,0.12);\n  border-radius: 8px;\n}\n.chat-messages::-webkit-scrollbar-track {\n  background: transparent;\n}\n\n.message {\n  max-width: 70%;\n  padding: 14px 18px;\n  border-radius: 18px;\n  line-height: 1.6;\n  word-wrap: break-word;\n  position: relative;\n  animation: messageSlideIn 0.28s ease-out;\n  font-size: 15px;\n  box-sizing: border-box;\n}\n\n@keyframes messageSlideIn {\n  from {\n    opacity: 0;\n    transform: translateY(12px) scale(0.98);\n  }\n  to {\n    opacity: 1;\n    transform: translateY(0) scale(1);\n  }\n}\n\n.user-message {\n  align-self: flex-end;\n  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n  color: white;\n  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.16);\n}\n\n.user-message::after {\n  content: '';\n  position: absolute;\n  bottom: -6px;\n  right: 18px;\n  width: 0;\n  height: 0;\n  border-left: 8px solid transparent;\n  border-right: 8px solid transparent;\n  border-top: 8px solid #764ba2;\n}\n\n.ai-message {\n  align-self: flex-start;\n  background: rgba(255, 255, 255, 0.95);\n  backdrop-filter: blur(4px);\n  color: #2c3e50;\n  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);\n  border: 1px solid rgba(255, 255, 255, 0.3);\n}\n\n.ai-message::after {\n  content: '';\n  position: absolute;\n  bottom: -6px;\n  left: 18px;\n  width: 0;\n  height: 0;\n  border-left: 8px solid transparent;\n  border-right: 8px solid transparent;\n  border-top: 8px solid rgba(255, 255, 255, 0.95);\n}\n\n.message-header {\n  display: flex;\n  align-items: center;\n  gap: 10px;\n  margin-bottom: 8px;\n}\n\n.message-header b {\n  font-weight: 600;\n}\n\n.tts-btn {\n  padding: 6px 10px;\n  border-radius: 8px;\n  font-size: 12px;\n  cursor: pointer;\n  background: linear-gradient(135deg, #67c23a 0%, #409eff 100%);\n  color: white;\n  border: none;\n  transition: all 0.18s ease;\n  box-shadow: 0 2px 8px rgba(103, 194, 58, 0.18);\n}\n\n.tts-btn:hover {\n  transform: scale(1.05);\n  box-shadow: 0 4px 12px rgba(103, 194, 58, 0.25);\n}\n\n.streaming-indicator {\n  color: #999;\n  font-weight: 600;\n  margin-left: 6px;\n}\n\n/* message content */\n.message-content {\n  white-space: pre-wrap;\n  word-break: break-word;\n}\n\n/* input area */\n.chat-input {\n  padding: 24px;\n  background: rgba(255, 255, 255, 0.96);\n  backdrop-filter: blur(8px);\n  border-top: 1px solid rgba(0, 0, 0, 0.06);\n  position: relative;\n  z-index: 1;\n}\n\n.chat-input textarea {\n  width: 100%;\n  resize: none;\n  border: 2px solid rgba(0, 0, 0, 0.06);\n  border-radius: 12px;\n  padding: 14px 16px;\n  font-size: 15px;\n  outline: none;\n  background: rgba(255,255,255,0.96);\n  color: #2c3e50;\n  transition: all 0.18s ease;\n  min-height: 20px;\n  max-height: 160px;\n  box-shadow: 0 2px 10px rgba(0,0,0,0.04);\n}\n\n.chat-input textarea:focus {\n  border-color: #409eff;\n  box-shadow: 0 8px 30px rgba(64,158,255,0.06);\n  transform: translateY(-1px);\n}\n\n.send-btn {\n  position: absolute;\n  right: 36px;\n  bottom: 30px;\n  padding: 12px 22px;\n  border: none;\n  border-radius: 50px;\n  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n  color: white;\n  font-size: 15px;\n  font-weight: 600;\n  cursor: pointer;\n  box-shadow: 0 6px 20px rgba(102,126,234,0.18);\n  transition: all 0.18s ease;\n}\n\n.send-btn:hover:not(:disabled) {\n  transform: translateY(-3px) scale(1.02);\n}\n\n.send-btn:disabled {\n  background: #ccc;\n  box-shadow: none;\n  cursor: not-allowed;\n}\n</style>\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}